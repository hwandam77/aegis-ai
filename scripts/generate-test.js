#!/usr/bin/env node
/**
 * generate-test.js
 * AI ì‚¼ìœ„ì¼ì²´ í…ŒìŠ¤íŠ¸ ìë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸
 *
 * Usage:
 *   node scripts/generate-test.js <moduleName> <category>
 *
 * Example:
 *   node scripts/generate-test.js myModule core
 */

const fs = require('fs');
const path = require('path');

// ANSI ìƒ‰ìƒ
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  magenta: '\x1b[35m',
  cyan: '\x1b[36m',
};

async function generateTest() {
  console.log('\n' + colors.bright + colors.cyan + 'ğŸ¤– AI ì‚¼ìœ„ì¼ì²´ í…ŒìŠ¤íŠ¸ ìƒì„±ê¸°' + colors.reset + '\n');

  // ì»¤ë§¨ë“œ ë¼ì¸ ì¸ì íŒŒì‹±
  const args = process.argv.slice(2);

  if (args.length < 2) {
    printUsage();
    process.exit(1);
  }

  const moduleName = args[0];
  const category = args[1]; // core, services, handlers
  const description = args[2] || '';

  // ìœ íš¨ì„± ê²€ì‚¬
  if (!['core', 'services', 'handlers'].includes(category)) {
    console.log(colors.yellow + 'âŒ Category must be: core, services, or handlers' + colors.reset);
    process.exit(1);
  }

  console.log(colors.blue + 'ğŸ“ Module Information:' + colors.reset);
  console.log(`  Name: ${colors.bright}${moduleName}${colors.reset}`);
  console.log(`  Category: ${colors.bright}${category}${colors.reset}`);
  console.log(`  Description: ${description || 'Auto-generated'}` + '\n');

  // íŒŒì¼ ê²½ë¡œ ìƒì„±
  const testPath = path.join(__dirname, `../tests/${category}/${moduleName}.test.js`);
  const srcPath = path.join(__dirname, `../src/${category}/${moduleName}.js`);

  // ì´ë¯¸ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
  if (fs.existsSync(testPath)) {
    console.log(colors.yellow + `âš ï¸  Test file already exists: ${testPath}` + colors.reset);
    console.log(colors.yellow + 'Overwrite? (y/N): ' + colors.reset);
    // ê°„ë‹¨í•˜ê²Œ ì§„í–‰
  }

  console.log(colors.green + '\nğŸ§  Step 1: Generating BDD Specification...' + colors.reset);
  console.log(colors.cyan + '   (Gemini would analyze requirements here)' + colors.reset);

  // BDD í…œí”Œë¦¿ ìƒì„±
  const bddTemplate = generateBDDTemplate(moduleName, category);
  console.log(colors.green + 'âœ… BDD specification generated' + colors.reset);

  console.log(colors.green + '\nâš™ï¸  Step 2: Generating Jest Test Code...' + colors.reset);
  console.log(colors.cyan + '   (Qwen would generate test code here)' + colors.reset);

  // Jest í…ŒìŠ¤íŠ¸ í…œí”Œë¦¿ ìƒì„±
  const testCode = generateJestTemplate(moduleName, category, bddTemplate);
  console.log(colors.green + 'âœ… Jest test code generated' + colors.reset);

  console.log(colors.green + '\nğŸ’¾ Step 3: Saving Files...' + colors.reset);

  // í…ŒìŠ¤íŠ¸ íŒŒì¼ ì €ì¥
  fs.writeFileSync(testPath, testCode);
  console.log(colors.green + `âœ… Test saved: ${testPath}` + colors.reset);

  // ì†ŒìŠ¤ íŒŒì¼ í…œí”Œë¦¿ ìƒì„± (ì•„ì§ ì—†ëŠ” ê²½ìš°)
  if (!fs.existsSync(srcPath)) {
    const srcTemplate = generateSourceTemplate(moduleName, category);
    fs.writeFileSync(srcPath, srcTemplate);
    console.log(colors.green + `âœ… Source template saved: ${srcPath}` + colors.reset);
  }

  console.log(colors.bright + colors.magenta + '\nğŸ‰ Test generation complete!' + colors.reset);
  console.log(colors.cyan + '\nNext steps:' + colors.reset);
  console.log(`  1. Review the generated test: ${testPath}`);
  console.log(`  2. Run: ${colors.bright}npm test ${testPath}${colors.reset}`);
  console.log(`  3. Implement: ${srcPath}`);
  console.log(`  4. Follow TDD cycle: ğŸ”´ RED â†’ ğŸŸ¢ GREEN â†’ ğŸ”µ REFACTOR\n`);
}

function printUsage() {
  console.log(colors.bright + 'Usage:' + colors.reset);
  console.log(`  node scripts/generate-test.js <moduleName> <category> [description]\n`);
  console.log(colors.bright + 'Arguments:' + colors.reset);
  console.log(`  moduleName   - Name of the module (e.g., myHandler)`);
  console.log(`  category     - core | services | handlers`);
  console.log(`  description  - Optional module description\n`);
  console.log(colors.bright + 'Example:' + colors.reset);
  console.log(`  node scripts/generate-test.js authHandler handlers "Authentication handler"\n`);
}

function generateBDDTemplate(moduleName, category) {
  return `
BDD Specification for ${moduleName}:

Scenario 1: Basic functionality
  Given: Module is initialized
  When: Primary function is called
  Then: Expected result is returned

Scenario 2: Error handling
  Given: Invalid input
  When: Function is called
  Then: Error is thrown

Scenario 3: Edge case
  Given: Boundary condition
  When: Function is called
  Then: Handles gracefully
`;
}

function generateJestTemplate(moduleName, category, bddSpec) {
  const className = moduleName.charAt(0).toUpperCase() + moduleName.slice(1);

  return `// tests/${category}/${moduleName}.test.js
// Auto-generated by generate-test.js

const { ${className} } = require('../../src/${category}/${moduleName}');

describe('${className}', () => {
  let instance;

  beforeEach(() => {
    instance = new ${className}();
  });

  describe('Basic functionality', () => {
    test('should initialize correctly', () => {
      expect(instance).toBeDefined();
    });

    test('should perform primary operation', () => {
      // TODO: Implement based on BDD specification
      // Given: Module is initialized
      // When: Primary function is called
      // Then: Expected result is returned

      // Example:
      // const result = instance.execute();
      // expect(result).toBeDefined();
    });
  });

  describe('Error handling', () => {
    test('should throw error on invalid input', () => {
      // TODO: Implement error handling test
      expect(() => {
        // instance.execute(null);
      }).toThrow();
    });
  });

  describe('Edge cases', () => {
    test('should handle edge case', () => {
      // TODO: Implement edge case test
    });
  });
});

/*
BDD Specification:
${bddSpec}

Next Steps:
1. Run: npm test tests/${category}/${moduleName}.test.js
2. Implement the module to make tests pass
3. Refactor and improve
*/
`;
}

function generateSourceTemplate(moduleName, category) {
  const className = moduleName.charAt(0).toUpperCase() + moduleName.slice(1);

  return `/**
 * ${moduleName}.js
 * Auto-generated by generate-test.js
 *
 * @module ${moduleName}
 */

/**
 * ${className} class
 */
class ${className} {
  constructor(options = {}) {
    // TODO: Initialize
  }

  /**
   * Primary method
   *
   * @returns {*}
   */
  execute() {
    // TODO: Implement
    throw new Error('Not implemented');
  }
}

module.exports = { ${className} };
`;
}

// ì‹¤í–‰
generateTest().catch(error => {
  console.error(colors.yellow + '\nâŒ Error:', error.message + colors.reset);
  process.exit(1);
});
