name: Coverage Report

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    name: Generate Coverage Report
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Generate coverage
      run: npm run test:coverage -- --passWithNoTests

    - name: Check coverage thresholds
      run: |
        if [ -f coverage/coverage-summary.json ]; then
          echo "üìä Coverage Summary:"
          cat coverage/coverage-summary.json | jq '.total'

          # Extract coverage percentages
          STATEMENTS=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          BRANCHES=$(cat coverage/coverage-summary.json | jq '.total.branches.pct')
          FUNCTIONS=$(cat coverage/coverage-summary.json | jq '.total.functions.pct')
          LINES=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')

          echo "Statements: $STATEMENTS%"
          echo "Branches: $BRANCHES%"
          echo "Functions: $FUNCTIONS%"
          echo "Lines: $LINES%"

          # Check if coverage meets minimum thresholds (currently informational)
          if (( $(echo "$STATEMENTS < 70" | bc -l) )); then
            echo "‚ö†Ô∏è Warning: Statement coverage ($STATEMENTS%) is below target (70%)"
          fi
        else
          echo "‚ÑπÔ∏è No tests found yet. Coverage report will be generated once tests are added."
        fi
      continue-on-error: true

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage/
          coverage/lcov-report/
        retention-days: 30

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          if (!fs.existsSync('coverage/coverage-summary.json')) {
            console.log('No coverage file found, skipping comment');
            return;
          }

          const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
          const { statements, branches, functions, lines } = coverage.total;

          const body = `## üìä Test Coverage Report

          | Metric | Coverage | Status |
          |--------|----------|--------|
          | Statements | ${statements.pct}% | ${statements.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |
          | Branches | ${branches.pct}% | ${branches.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |
          | Functions | ${functions.pct}% | ${functions.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |
          | Lines | ${lines.pct}% | ${lines.pct >= 70 ? '‚úÖ' : '‚ö†Ô∏è'} |

          **Target**: 70% overall coverage

          ${statements.pct >= 70 ? '‚úÖ Coverage meets target!' : '‚ö†Ô∏è Coverage below target - please add more tests'}
          `;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
      continue-on-error: true
